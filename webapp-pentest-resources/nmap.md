### Nmap

Example target: `192.168.1.10`

#### Basic commands

Scan a single IP:
```sh
nmap 192.168.1.10
```

Scan multiple IP addresses:
```sh
nmap 192.168.1.10 192.168.1.11
```

Scan a domain:
```sh
nmap scanme.nmap.org
```

Note: [scanme.nmap.org](http://scanme.nmap.org) is a machine set up to help people learn about Nmap and test Nmap installation.

Scan a range:
```sh
nmap 192.168.1.10-254
```

Scan multiple ranges:
```sh
nmap 192.168.1.1-255 192.168.2.1-255
```

>"Why up to .255? Aren’t the hosts only up to .254?"
In a typical /24 subnet (like 192.168.1.0/24),
- `192.168.1.0` is the network address
- `192.168.1.255` is the broadcast address
Valid host addresses are `192.168.1.1` through `192.168.1.254`
So yes, the actual usable hosts end at `.254`, not `.255`.

However, when you give nmap a range like:
```sh
nmap 192.168.1.1-255
```
nmap will attempt to scan all those addresses, including `.255`.
It’s not wrong syntactically; it just means you’re also probing the broadcast address, which typically won’t respond (and in some networks could cause extra noise).

With that being said, the best pratice is to use `.1-254` or the CIDR notation such as following which is cleaner and ensures nmap knows it’s a standard /24 subnet.

Scan using a CIDR (Classes Inter-Domain Routing) notation:
```sh
nmap 192.168.1.0/24
```

Note: [What is CIDR? - GeeksforGeeks](https://www.geeksforgeeks.org/computer-networks/classless-inter-domain-routing-cidr/)


Scan using a few parameters:
```sh
nmap -sV -sC -sT -p- 192.168.1.10
```

| Option            | Description                                        |
| ----------------- | -------------------------------------------------- |
| `-sS`             | **SYN scan** (stealthy and fast)                   |
| `-sT`             | **TCP connect** scan (less stealthy)               |
| `-sU`             | **UDP scan**                                       |
| `-sV`             | **Service version detection**                      |
| `-sC`             | Run Nmap scripts (particularly to reveal types of the software, like Vsftpd which is a type of FTP)                      |
| `-O`              | **OS detection**                                   |
| `-A`              | Aggressive scan: OS, services, traceroute, scripts |
| `-p`              | Specify port(s) (e.g., `-p 22`, `-p 1-1000`)       |
| `-p-`             | Scan all ports                                     |
| `-Pn`             | Skip host discovery (use if ICMP is blocked)       |
| `-T4`             | Set timing template for faster scanning            |
| `-oN` / `-oX`     | Output results to file (normal/XML)                |
| `--script=<name>` | Run specific NSE script(s)                         |

Note: `-sT` is similar with SYN scans but sends more packets. It is loud in network and easily detectable. However, this is used by default even if you don't specify it.

##### Scan multiple targets from a file

```sh
nmap -iL targets.txt
```

###### Possible content of tagrts.txt
```sh
# Production webservers
web1.company.local
web2.company.local

# Internal subnets
192.168.10.0/24

# Specific hosts
192.168.1.15
192.168.1.20-25

# IPv6 test host
2001:db8::5
```

##### Fast and Verbose scan

Background question: What do you think if you do the following?
```sh
nmap 192.168.1.10
```
Nmap scans 1000 most commonly used ports.

If you want to do the scan faster, you can use the `-F` parameter in order to only scan 100 most commonly used ports:
```sh
nmap -F 192.168.1.10
```

If you want to see what's going on in the scan process, you can use `-v` to verbose it:
```sh
nmap -F 192.168.1.10 -v
```

for greater verbosity:
```sh
nmap -F 192.168.1.10 -vv
```


##### Scan a particular port

```sh
nmap -p 80 192.168.1.10
```

Want to skip ping to avoid 'Host seems down'? Use this:

```sh
nmap -Pn -p 80 192.168.1.10
```

##### Scan several ports

```sh
nmap -Pn -p 21,22,25,80,445,3389,8080 192.168.1.10
```

Note: If you see 'filtered' in the 'STATE' column of an nmap scan result, there is a good chance that a firewall exists in the system (target).

Also, this is how to see if a firewall is within the system you're in (localhost = 127.0.0.1):
```sh
nmap -Pn -p 21,22,25,80,445,3389,8080 127.0.0.1
```

Scan some ports using a range:
```sh
nmap -p 21-1000 192.168.1.10
```

Scan multiple TCP and UDP ports:
```sh
nmap -p U:53,T:21-25,80,443,8080 192.168.1.10
```

Scan ports from their service names:
```sh
nmap -p http,https 192.168.1.10
```

##### Scan all ports

```sh
nmap -p- 192.168.1.10
```

To avoid 'Host seems down':
```sh
nmap -Pn -p- 192.168.1.10
```

In order to increase the speed of the scan (More vulnerable to IDS though):
```sh
nmap -Pn -T4 -p- 192.168.1.10
```

Rule of thumb: 
```
NEVER assume that every system is configured the same, be it Windows, Linux, or other systems. You may end up finding services running on other ports (which is actually common in real world).
```

##### Skip ping

Note: important, especially if a "normal" scan (without params) says "Host seems down"

```sh
nmap -Pn 192.168.1.10
```

##### UDP Scan

Note: Nmap does TCP scan by default

```sh
nmap -sU 192.168.1.10
```

##### Service and OS Detection Scan

```sh
### Service scan
nmap -sV 192.168.1.10
```

```sh
### Service and OS detection scan
nmap -sV -O 192.168.1.10
```

##### Default Scripts Scan

```sh
nmap -sC 192.168.1.10
```

##### Output to a file

Save the terminal output

```sh
nmap 192.168.1.10 -oN nmap_scan
```

Save the output into an XML format (can be imported to Metasploit)

```sh
nmap -oX nmap_scan 192.168.1.10
```

Save thr output into: Normal (.nmap), XML (.xml), and Grepable (.gnmap) formats

```sh
nmap -oA nmap_scan 192.168.1.10
```

Append output to a previous scan file:
```sh
nmap 192.168.1.10 -oN nmap_scan --append-output
```

##### Aggressive scan

Note: `-A` = `-sV` + `-O` + `-sC`

```sh
nmap -A 192.168.1.10
```

##### 'Skip ping' scan

Background: there are some cases in which if you perform 
```sh
nmap 192.168.1.10
```
Nmap will reply with 'Host seems down' and not even continue to port scanning. This is because Nmap carries out host discovery, then do port scanning.

In order to avoid such cases, you can do a "don't ping" scan:

```sh
nmap -Pn 192.168.1.10 
```


##### TCP-SYN ping scans: One of the most accurate way to tell if a host is up (host discovery)

Port 3389 as an example:

```sh
nmap -sn -PS3389 192.168.1.10
```

Several ports as an example:

```sh
nmap -sn -PS80,3389,445 192.168.1.10
```

A range of ports as an example:

```sh
nmap -sn -PS1-1000 192.168.1.10
```

Important note: When doing host discovery, `nmap -PS80,3390,445 192.168.1.10` takes longer than `nmap -sn -PS80,3389,445` because `-sn` skips port scanning and does ping scans.


##### TCP-ACK pings: not recommended for host discovery

Note: Not recommended for host discovery because certain systems might be configured to block packets with ACK flags set. (But might be useful for firewall discovery?)

Sending packets without SYN:

```sh
nmap -sn -PA 192.168.1.10
```

##### ICMP ping scans

Host discovery ICMP echo requests:
```sh
nmap -sn -PE 192.168.1.10 --send-ip
```

##### Firewall & IDS Evasion

(1) Using fragmented packets

The idea is to send packets in smaller packets so IDS can not analyze them, whether those are packets to be flagged or not.

Note: `-f` to send fragmented packets

```sh
nmap -Pn -sS -sV -p- -f 192.168.1.10
```

```sh
nmap -sV -O -sC -f --data-length 200 192.168.1.10
```

Note: `--mtu` means maximum transmitted units. The size of mtu is > 0 and a multiple of 8.


```sh
nmap -sV -O -sC -f --mtu 8 192.168.1.10
```

(2) Using decoy IP addresses

```sh
nmap -D 192.168.1.63,192.168.1.65 192.168.1.10
```

```sh
nmap -Pn -sS -sV -sV -p- -f --data-length 200 -D 192.168.1.63,192.168.1.65 192.168.1.10
```

Note:
- Decoy IPs are `192.168.1.63` and `192.168.1.65`
- The target IP is `192.168.1.10`


(3) Append random data to sent packets

```sh
nmap --data-length 200 192.168.1.10
```


(4) Set your own offset size

```sh
nmap 192.168.1.10 --mtu 32
```


(5) Relay connections through HTTP/SOCK4 proxies

```sh
nmap --proxies http://192.168.1.13:8000,http://192.168.1.17:8080 192.168.1.10
```

###### Example of Firewall/IDS Evasion command

```sh
nmap -f -t 0 -n -Pn --data-length 200 -D 192.168.1.15,192.168.1.21,192.168.1.23,192.168.1.27 192.168.1.10
```


##### My go-to

```sh
nmap -Pn -sS -sV -O -sC -p- 192.168.1.10 -v
```

or

```sh
nmap -Pn -sS -A -p- 192.168.1.10 -v
```

often used in exams:
```sh
nmap -Pn -sS -sV -O -sC -p- 192.168.1.10 -oA scan_result
```

Note: 
- Another case: Ping scans for a general sweep of the network -> TCP-SYN ping scans (for systems that might block ping scans)

Other good examples (these are for host discovery):

```sh
nmap -sn -T4 192.168.1.10 -v
```

```sh
nmap -sn -PS21,22,25,80,445,3389,8080 -T4 192.168.1.10 -v
```

In the event of Windows, combine with UDP scanning using `-PU`:
(because some firewalls might be configured only for TCP, not for UDP...)

```sh
nmap -sn -PS21,22,25,80,445,3389,8080 -PU137,138 -T4 192.168.1.10 -v
```

Scanning an entire network? Just specify the subnet:
(This takes longer because it scans a bunch of IPs)

```sh
nmap -sn -PS21,22,25,80,445,3389,8080 -PU137,138 -T4 192.168.1.0/24 -v
```

Note: in order to specify the subnet, run `ifconfig` or `ip a s`.

##### Enable ipv6 scanning 

```sh
nmap -6 2207:d9e1:1003:33::5
```

##### Show the details of packets captured during a scan

```sh
nmap 192.168.1.1 --packet-trace
```

##### Traceroute to random targets without a port scan

```sh
nmap -iR 10 -sn -traceroute
```

##### Debug mode

```sh
nmap 192.168.1.10 -d
```

Increase debugging level:
```sh
nmap 192.168.1.10 -dd
```

##### Display a reason why a port is in a particular state

```sh
nmap 192.168.1.10 -reason
```
Probably will yield in the same output as `-vv`


References:
- eJPT training - INESecurity
- [Nmap - StationX](https://www.stationx.net/nmap-cheat-sheet/)
